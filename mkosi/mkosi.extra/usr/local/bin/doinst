#!/usr/bin/python

import subprocess
import os
import sys
from pathlib import Path

root = Path('/dev/gpt-auto-root')

# sda                               8:0    1   3.8G  0 disk
# └─sda1                            8:1    1   3.5G  0 part
# sdb                               8:16   1   3.8G  0 disk
# ├─sdb1                            8:17   1   1.5G  0 part
# └─sdb2                            8:18   1   2.3M  0 part

root_major = os.major(root.stat().st_rdev)
root_minor = os.minor(root.stat().st_rdev) & ~0xF

out = subprocess.check_output(['lsblk', '-nlb'], text=True)

disks = [line.split() for line in out.splitlines()
         if not line.startswith(' ')]

disks = [disk for disk in disks
         if (disk[5] == 'disk'
             and 'SWAP' not in disk[-1])]
disks.sort(key=lambda disk: -int(disk[3]))  # sort by size
maxlen = max(len(f'/dev/{disk[0]}') for disk in disks)

src, dst = None, None
for i, disk in enumerate(disks):
    if disk[1] == f'{root_major}:{root_minor}':
        assert src is None
        src = i
        label = '(src)'
    elif dst is None:
        dst = i
        label = '(dst)'
    else:
        label = ''

    size = int(disk[3])
    print(f"{label:5} {f'/dev/{disk[0]}':{maxlen}} - {size} B / {size/1024**3:.1f} GB")

if src is None:
    sys.exit('Cannot find source disk')
if dst is None:
    sys.exit('Cannot find destination disk')

cmd = ['dd', 'bs=4096', 'status=progress',
       f'if=/dev/{disks[src][0]}',
       f'of=/dev/{disks[dst][0]}']
print('+', *cmd)
input('press enter to proceed')

subprocess.check_call(cmd)
cmd = ['sync']
print('+', *cmd)
subprocess.check_call(cmd)
print('*** READY ***')
