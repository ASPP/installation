---
  - name: Create student user
    remote_user: root
    vars_files:
      - passwords.yml
    hosts: all
    tasks:
      - name: Create student user
        when: ansible_distribution == "Ubuntu"
        user:
          name: student
          comment: ASPP Student
          groups: adm, sudo
          password: "{{ student_password }}"
          shell: "/bin/bash"
        tags: remote

      - name: Create student user
        when: ansible_distribution == "Fedora"
        user:
          name: student
          comment: ASPP Student
          groups: adm, wheel
          password: "{{ student_password }}"
          shell: "/bin/bash"
        tags: remote

      - name: Set authorized key taken from file
        authorized_key:
          user: student
          state: present
          key: "{{ lookup('file', '~/.ssh/id_ecdsa_aspp.pub') }}"
          exclusive: no
        ignore_errors: yes

      - name: Allow password authentication (Fedora)
        when: ansible_distribution == "Fedora"
        copy:
          content: |
             PasswordAuthentication yes

          dest: /etc/ssh/sshd_config.d/80-password-auth.conf

      - name: Allow X forwarding (Fedora)
        when: ansible_distribution == "Fedora"
        copy:
          content: |
             ForwardX11 yes

          dest: /etc/ssh/ssh_config.d/80-x-forwarding.conf

      - name: Reload sshd config
        ansible.builtin.systemd:
          name: sshd.service
          state: reloaded

      - name: Set up autologin
        when: ansible_distribution == "Ubuntu"
        copy:
          src: files/custom.conf
          dest: /etc/gdm3/
        tags: remote

      - name: Set up autologin
        when: ansible_distribution == "Fedora"
        copy:
          src: files/custom.conf
          dest: /etc/gdm/
        tags: remote

      - name: Setup /etc/firefox/sysprefs.js
        copy:
          src: files/sysprefs.js
          dest: /etc/firefox/
        tags: remote

      - name: Set timezone to Europe/Madrid
        timezone:
          name: Europe/Rome
        tags: remote

      - name: Set language to English
        copy:
          content: |
            LANG=en_US.UTF-8
          dest: /etc/locale.conf
        tags: remote

      - name: Set language to English
        copy:
          content: |
            LANG=en_US.UTF-8
          dest: /etc/default/locale
        tags: remote
        when: ansible_distribution == "Ubuntu"
